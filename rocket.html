<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket - Casino Gift Contract</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .rocket-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .rocket-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .rocket-canvas {
            width: 100%;
            height: 300px;
            background: linear-gradient(180deg, #0d1117 0%, #1a1f2e 100%);
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .rocket {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            transition: bottom 0.1s linear;
        }
        
        .multiplier-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: #00b894;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
        }
        
        .bet-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .bet-input {
            flex: 1;
            padding: 12px;
            background: rgba(35, 40, 52, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            min-width: 120px;
        }
        
        .place-bet-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #00b894, #008066);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .place-bet-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .cashout-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #fdcb6e, #e6a336);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .cashout-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .game-info {
            background: rgba(25, 30, 42, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .bets-list {
            background: rgba(25, 30, 42, 0.8);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .bet-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .bet-item:last-child {
            border-bottom: none;
        }
        
        .explosion {
            position: absolute;
            font-size: 60px;
            animation: explode 0.5s ease-out;
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .trail {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom, transparent, #ff6b6b);
            animation: trail 1s linear;
        }
        
        @keyframes trail {
            from { height: 0; opacity: 1; }
            to { height: 100px; opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        
        <div class="rocket-header">
            <h1>üöÄ Rocket Game</h1>
            <div class="balance">
                –ë–∞–ª–∞–Ω—Å: <span id="balance">0</span> TON
                <span id="demo-badge" style="margin-left: 10px; padding: 2px 8px; background: #ffc107; border-radius: 10px; font-size: 12px;">TESTNET</span>
            </div>
        </div>

        <div class="rocket-container">
            <div class="rocket-canvas" id="rocketCanvas">
                <div class="multiplier-display" id="multiplierDisplay">1.00x</div>
                <div class="rocket" id="rocket">üöÄ</div>
            </div>

            <div class="bet-controls">
                <input type="number" class="bet-input" id="betAmount" min="1" max="50" step="1" value="1" placeholder="–°—Ç–∞–≤–∫–∞ –≤ TON">
                <button class="place-bet-btn" id="placeBetBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
                <button class="cashout-btn" id="cashoutBtn" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
            </div>

            <div class="game-info">
                <div class="info-row">
                    <span>–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞:</span>
                    <span id="yourBet">0 TON</span>
                </div>
                <div class="info-row">
                    <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:</span>
                    <span id="potentialWin">0 TON</span>
                </div>
                <div class="info-row">
                    <span>–¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å:</span>
                    <span id="currentMultiplier">1.00x</span>
                </div>
            </div>

            <div class="bets-list">
                <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞–≤–∫–∏</h3>
                <div id="betsContainer">
                    <div class="no-bets">–°—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGame = null;
        let isDemoMode = true;
        let userData = null;
        let rocketInterval = null;
        let currentMultiplier = 1.00;
        let userBet = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            setupEventListeners();
            loadActiveBets();
        });

        function goBack() {
            window.location.href = 'index.html';
        }

        async function loadUserData() {
            try {
                const tg = window.Telegram.WebApp;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const telegramId = tg.initDataUnsafe.user.id;
                    
                    const response = await fetch(`/api/user/${telegramId}`);
                    if (response.ok) {
                        userData = await response.json();
                        document.getElementById('balance').textContent = userData.balance.toFixed(2);
                        isDemoMode = userData.demo_mode;
                        document.getElementById('demo-badge').textContent = isDemoMode ? 'TESTNET' : 'MAINNET';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function setupEventListeners() {
            document.getElementById('placeBetBtn').addEventListener('click', placeBet);
            document.getElementById('cashoutBtn').addEventListener('click', cashout);
        }

        async function placeBet() {
            const betAmount = parseFloat(document.getElementById('betAmount').value);
            
            if (betAmount < 1 || betAmount > 50) {
                alert('–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 50 TON');
                return;
            }

            try {
                const tg = window.Telegram.WebApp;
                const telegramId = tg.initDataUnsafe.user.id;

                const response = await fetch('/api/rocket/place-bet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegramId: telegramId,
                        betAmount: betAmount,
                        demoMode: isDemoMode
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error || '–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    userBet = {
                        betId: result.betId,
                        amount: betAmount,
                        cashoutMultiplier: 1.00
                    };

                    document.getElementById('yourBet').textContent = betAmount + ' TON';
                    document.getElementById('placeBetBtn').disabled = true;
                    document.getElementById('cashoutBtn').disabled = false;
                    updateBalance();

                    // –ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–µ
                    if (!currentGame) {
                        startGame();
                    }

                    addBetToList(tg.initDataUnsafe.user.first_name, betAmount);
                }
            } catch (error) {
                console.error('Place bet error:', error);
                alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏');
            }
        }

        function startGame() {
            currentMultiplier = 1.00;
            currentGame = {
                startTime: Date.now(),
                explosionPoint: generateExplosionPoint()
            };

            rocketInterval = setInterval(updateRocket, 100);
        }

        function generateExplosionPoint() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ—á–∫—É –≤–∑—Ä—ã–≤–∞ –º–µ–∂–¥—É 1.1x –∏ 100x
            return 1.1 + Math.random() * 98.9;
        }

        function updateRocket() {
            if (!currentGame) return;

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å (–ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è –∫—Ä–∏–≤–∞—è –∫–∞–∫ –≤ 1win)
            const timeElapsed = (Date.now() - currentGame.startTime) / 1000;
            currentMultiplier = 1 + Math.pow(timeElapsed, 1.5) / 10;

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('multiplierDisplay').textContent = currentMultiplier.toFixed(2) + 'x';
            document.getElementById('currentMultiplier').textContent = currentMultiplier.toFixed(2) + 'x';
            
            if (userBet) {
                const potentialWin = userBet.amount * currentMultiplier;
                document.getElementById('potentialWin').textContent = potentialWin.toFixed(2) + ' TON';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–∞–∫–µ—Ç—ã
            const rocket = document.getElementById('rocket');
            const canvasHeight = document.getElementById('rocketCanvas').offsetHeight;
            const rocketPosition = Math.min(100, (currentMultiplier / 100) * 80);
            rocket.style.bottom = (50 + rocketPosition) + 'px';

            // –°–æ–∑–¥–∞–µ–º —Å–ª–µ–¥
            createTrail();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∑—Ä—ã–≤
            if (currentMultiplier >= currentGame.explosionPoint) {
                explode();
            }
        }

        function createTrail() {
            const rocket = document.getElementById('rocket');
            const trail = document.createElement('div');
            trail.className = 'trail';
            
            const rocketRect = rocket.getBoundingClientRect();
            const canvasRect = document.getElementById('rocketCanvas').getBoundingClientRect();
            
            trail.style.left = (rocketRect.left + rocketRect.width/2 - canvasRect.left) + 'px';
            trail.style.bottom = (rocketRect.bottom - canvasRect.bottom) + 'px';
            
            document.getElementById('rocketCanvas').appendChild(trail);
            
            setTimeout(() => {
                trail.remove();
            }, 1000);
        }

        function explode() {
            clearInterval(rocketInterval);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –≤–∑—Ä—ã–≤–∞
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'üí•';
            explosion.style.left = '50%';
            explosion.style.bottom = document.getElementById('rocket').style.bottom;
            
            document.getElementById('rocketCanvas').appendChild(explosion);
            
            setTimeout(() => {
                explosion.remove();
                resetGame();
            }, 500);

            // –í—Å–µ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—é—Ç
            if (userBet) {
                userBet = null;
                document.getElementById('yourBet').textContent = '0 TON';
                document.getElementById('potentialWin').textContent = '0 TON';
                document.getElementById('cashoutBtn').disabled = true;
                document.getElementById('placeBetBtn').disabled = false;
            }
        }

        async function cashout() {
            if (!userBet) return;

            try {
                const tg = window.Telegram.WebApp;
                const telegramId = tg.initDataUnsafe.user.id;

                const response = await fetch('/api/rocket/cashout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        betId: userBet.betId,
                        cashoutMultiplier: currentMultiplier,
                        telegramId: telegramId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error || '–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    alert(`–£—Å–ø–µ—à–Ω–æ! –í—ã–∏–≥—Ä—ã—à: ${result.winAmount.toFixed(2)} TON`);
                    userBet = null;
                    document.getElementById('yourBet').textContent = '0 TON';
                    document.getElementById('potentialWin').textContent = '0 TON';
                    document.getElementById('cashoutBtn').disabled = true;
                    document.getElementById('placeBetBtn').disabled = false;
                    updateBalance();
                }
            } catch (error) {
                console.error('Cashout error:', error);
                alert('–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞');
            }
        }

        function resetGame() {
            currentGame = null;
            document.getElementById('rocket').style.bottom = '50px';
            document.getElementById('multiplierDisplay').textContent = '1.00x';
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (document.getElementById('betsContainer').children.length > 0) {
                    startGame();
                }
            }, 3000);
        }

        function addBetToList(username, amount) {
            const betsContainer = document.getElementById('betsContainer');
            
            if (betsContainer.querySelector('.no-bets')) {
                betsContainer.innerHTML = '';
            }

            const betItem = document.createElement('div');
            betItem.className = 'bet-item';
            betItem.innerHTML = `
                <span>${username}:</span>
                <span>${amount} TON</span>
            `;
            
            betsContainer.appendChild(betItem);
            betsContainer.scrollTop = betsContainer.scrollHeight;
        }

        async function loadActiveBets() {
            try {
                const response = await fetch('/api/rocket/active-bets');
                if (response.ok) {
                    const bets = await response.json();
                    const betsContainer = document.getElementById('betsContainer');
                    
                    if (bets.length > 0) {
                        betsContainer.innerHTML = '';
                        bets.forEach(bet => {
                            addBetToList(bet.username, bet.amount);
                        });
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
                        startGame();
                    }
                }
            } catch (error) {
                console.error('Load bets error:', error);
            }
        }

        async function updateBalance() {
            try {
                const tg = window.Telegram.WebApp;
                const telegramId = tg.initDataUnsafe.user.id;
                
                const response = await fetch(`/api/user/${telegramId}`);
                if (response.ok) {
                    userData = await response.json();
                    document.getElementById('balance').textContent = userData.balance.toFixed(2);
                }
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }
    </script>
</body>
</html>