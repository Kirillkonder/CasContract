<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket - Casino Gift Contract</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .rocket-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .rocket-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .rocket-canvas {
            width: 100%;
            height: 300px;
            background: linear-gradient(180deg, #0d1117 0%, #1a1f2e 100%);
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .rocket {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            transition: bottom 0.1s linear;
        }
        
        .multiplier-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: #00b894;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
        }
        
        .bet-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .bet-input {
            flex: 1;
            padding: 12px;
            background: rgba(35, 40, 52, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            min-width: 120px;
        }
        
        .place-bet-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #00b894, #008066);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .place-bet-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .cashout-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #fdcb6e, #e6a336);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .cashout-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .game-info {
            background: rgba(25, 30, 42, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .bets-list {
            background: rgba(25, 30, 42, 0.8);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .bet-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .bet-item:last-child {
            border-bottom: none;
        }
        
        .explosion {
            position: absolute;
            font-size: 60px;
            animation: explode 0.5s ease-out;
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .trail {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom, transparent, #ff6b6b);
            animation: trail 1s linear;
        }
        
        @keyframes trail {
            from { height: 0; opacity: 1; }
            to { height: 100px; opacity: 0; }
        }

        .players-count {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #74b9ff;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .round-timer {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #fdcb6e;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .fake-players {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #a0a0a0;
            background: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        
        <div class="rocket-header">
            <h1>üöÄ Rocket Game</h1>
            <div class="balance">
                –ë–∞–ª–∞–Ω—Å: <span id="balance">0</span> TON
                <span id="demo-badge" style="margin-left: 10px; padding: 2px 8px; background: #ffc107; border-radius: 10px; font-size: 12px;">TESTNET</span>
            </div>
        </div>

        <div class="rocket-container">
            <div class="rocket-canvas" id="rocketCanvas">
                <div class="multiplier-display" id="multiplierDisplay">1.00x</div>
                <div class="players-count" id="playersCount">–ò–≥—Ä–æ–∫–æ–≤: 0</div>
                <div class="round-timer" id="roundTimer">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥: 10—Å</div>
                <div class="fake-players" id="fakePlayers">–í—Å–µ–≥–æ –æ–Ω–ª–∞–π–Ω: 50+</div>
                <div class="rocket" id="rocket">üöÄ</div>
            </div>

            <div class="bet-controls">
                <input type="number" class="bet-input" id="betAmount" min="1" max="50" step="1" value="1" placeholder="–°—Ç–∞–≤–∫–∞ –≤ TON">
                <button class="place-bet-btn" id="placeBetBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
                <button class="cashout-btn" id="cashoutBtn" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
            </div>

            <div class="game-info">
                <div class="info-row">
                    <span>–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞:</span>
                    <span id="yourBet">0 TON</span>
                </div>
                <div class="info-row">
                    <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:</span>
                    <span id="potentialWin">0 TON</span>
                </div>
                <div class="info-row">
                    <span>–¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å:</span>
                    <span id="currentMultiplier">1.00x</span>
                </div>
            </div>

            <div class="bets-list">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ (<span id="activeBetsCount">0</span>)</h3>
                <div id="betsContainer">
                    <div class="no-bets">–°—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGame = null;
        let isDemoMode = true;
        let userData = null;
        let rocketInterval = null;
        let currentMultiplier = 1.00;
        let userBet = null;
        let activePlayers = 0;
        let lastExplosionMultiplier = 1.0;
        let roundTimer = 10; // 10 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
        let timerInterval = null;
        let fakePlayersCount = 50; // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 50+ –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω

        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            setupEventListeners();
            loadActiveBets();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(loadActiveBets, 5000);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞ 50+ –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω
            updateFakePlayersCount();
        });

        function goBack() {
            window.location.href = 'index.html';
        }

        async function loadUserData() {
            try {
                const tg = window.Telegram.WebApp;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const telegramId = tg.initDataUnsafe.user.id;
                    
                    const response = await fetch(`/api/user/${telegramId}`);
                    if (response.ok) {
                        userData = await response.json();
                        document.getElementById('balance').textContent = userData.balance.toFixed(2);
                        isDemoMode = userData.demo_mode;
                        document.getElementById('demo-badge').textContent = isDemoMode ? 'TESTNET' : 'MAINNET';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function setupEventListeners() {
            document.getElementById('placeBetBtn').addEventListener('click', placeBet);
            document.getElementById('cashoutBtn').addEventListener('click', cashout);
        }

        async function placeBet() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –∏–¥–µ—Ç —Ç–∞–π–º–µ—Ä –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
            if (timerInterval) {
                alert('–ò–¥–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É! –ü–æ–¥–æ–∂–¥–∏—Ç–µ ' + roundTimer + ' —Å–µ–∫—É–Ω–¥');
                return;
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç
            if (currentGame) {
                alert('–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞!');
                return;
            }

            const betAmount = parseFloat(document.getElementById('betAmount').value);
            
            if (betAmount < 1 || betAmount > 50) {
                alert('–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 50 TON');
                return;
            }

            try {
                const tg = window.Telegram.WebApp;
                const telegramId = tg.initDataUnsafe.user.id;

                const response = await fetch('/api/rocket/place-bet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegramId: telegramId,
                        betAmount: betAmount,
                        demoMode: isDemoMode
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error || '–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏');
                    return;
                }

                if (result.success) {
                    userBet = {
                        betId: result.betId,
                        amount: betAmount,
                        cashoutMultiplier: 1.00
                    };

                    document.getElementById('yourBet').textContent = betAmount + ' TON';
                    document.getElementById('placeBetBtn').disabled = true;
                    document.getElementById('cashoutBtn').disabled = false;
                    updateBalance();

                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
                    if (!currentGame) {
                        startGame();
                    }

                    addBetToList(tg.initDataUnsafe.user.first_name, betAmount);
                    updatePlayersCount(1); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤
                }
            } catch (error) {
                console.error('Place bet error:', error);
                alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏: ' + error.message);
            }
        }

        function startGame() {
            currentMultiplier = 1.00;
            currentGame = {
                startTime: Date.now(),
                explosionPoint: generateExplosionPoint()
            };

            rocketInterval = setInterval(updateRocket, 100);
        }

        function generateExplosionPoint() {
            // –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏ –≤–∑—Ä—ã–≤–∞–º–∏
            const baseMultiplier = 1.1 + Math.random() * 3.9; // 1.1x - 5x
            const randomFactor = Math.random();
            
            // 70% chance –º–∞–ª–µ–Ω—å–∫–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (1.1x-5x)
            // 25% chance —Å—Ä–µ–¥–Ω–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (5x-15x)  
            // 5% chance –±–æ–ª—å—à–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (15x-100x)
            let explosionMultiplier;
            
            if (randomFactor < 0.7) {
                explosionMultiplier = baseMultiplier;
            } else if (randomFactor < 0.95) {
                explosionMultiplier = 5 + Math.random() * 10; // 5x-15x
            } else {
                explosionMultiplier = 15 + Math.random() * 85; // 15x-100x
            }
            
            lastExplosionMultiplier = explosionMultiplier;
            return explosionMultiplier;
        }

        function updateRocket() {
            if (!currentGame) return;

            // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –º–Ω–æ–∂–∏—Ç–µ–ª—è (–±–æ–ª–µ–µ —Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç)
            const timeElapsed = (Date.now() - currentGame.startTime) / 1000;
            currentMultiplier = 1 + Math.pow(timeElapsed, 1.8) / 8;

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('multiplierDisplay').textContent = currentMultiplier.toFixed(2) + 'x';
            document.getElementById('currentMultiplier').textContent = currentMultiplier.toFixed(2) + 'x';
            
            if (userBet) {
                const potentialWin = userBet.amount * currentMultiplier;
                document.getElementById('potentialWin').textContent = potentialWin.toFixed(2) + ' TON';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–∞–∫–µ—Ç—ã
            const rocket = document.getElementById('rocket');
            const canvasHeight = document.getElementById('rocketCanvas').offsetHeight;
            const maxHeight = 80; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤ %
            const rocketPosition = Math.min(maxHeight, (currentMultiplier / 100) * maxHeight);
            rocket.style.bottom = (50 + rocketPosition) + 'px';

            // –°–æ–∑–¥–∞–µ–º —Å–ª–µ–¥
            createTrail();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∑—Ä—ã–≤
            if (currentMultiplier >= currentGame.explosionPoint) {
                explode();
            }
        }

        function createTrail() {
            const rocket = document.getElementById('rocket');
            const trail = document.createElement('div');
            trail.className = 'trail';
            
            const rocketRect = rocket.getBoundingClientRect();
            const canvasRect = document.getElementById('rocketCanvas').getBoundingClientRect();
            
            trail.style.left = (rocketRect.left + rocketRect.width/2 - canvasRect.left) + 'px';
            trail.style.bottom = (rocketRect.bottom - canvasRect.bottom) + 'px';
            
            document.getElementById('rocketCanvas').appendChild(trail);
            
            setTimeout(() => {
                trail.remove();
            }, 1000);
        }

        function explode() {
            clearInterval(rocketInterval);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –≤–∑—Ä—ã–≤–∞
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'üí•';
            explosion.style.left = '50%';
            explosion.style.bottom = document.getElementById('rocket').style.bottom;
            
            document.getElementById('rocketCanvas').appendChild(explosion);
            
            setTimeout(() => {
                explosion.remove();
                resetGame();
            }, 500);

            // –í—Å–µ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—é—Ç
            if (userBet) {
                userBet = null;
                document.getElementById('yourBet').textContent = '0 TON';
                document.getElementById('potentialWin').textContent = '0 TON';
                document.getElementById('cashoutBtn').disabled = true;
                document.getElementById('placeBetBtn').disabled = false;
            }
        }

        async function cashout() {
            if (!userBet) return;

            try {
                const tg = window.Telegram.WebApp;
                const telegramId = tg.initDataUnsafe.user.id;

                const response = await fetch('/api/rocket/cashout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        betId: userBet.betId,
                        cashoutMultiplier: currentMultiplier,
                        telegramId: telegramId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error || '–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    alert(`–£—Å–ø–µ—à–Ω–æ! –í—ã–∏–≥—Ä—ã—à: ${result.winAmount.toFixed(2)} TON`);
                    userBet = null;
                    document.getElementById('yourBet').textContent = '0 TON';
                    document.getElementById('potentialWin').textContent = '0 TON';
                    document.getElementById('cashoutBtn').disabled = true;
                    document.getElementById('placeBetBtn').disabled = false;
                    updateBalance();
                }
            } catch (error) {
                console.error('Cashout error:', error);
                alert('–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞: ' + error.message);
            }
        }

        function resetGame() {
            clearInterval(rocketInterval);
            currentGame = null;
            document.getElementById('multiplierDisplay').textContent = '1.00x';
            document.getElementById('rocket').style.bottom = '50px';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
            startRoundTimer();
        }

        function startRoundTimer() {
            roundTimer = 10;
            document.getElementById('roundTimer').textContent = `–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥: ${roundTimer}—Å`;
            document.getElementById('placeBetBtn').disabled = true;
            
            timerInterval = setInterval(() => {
                roundTimer--;
                document.getElementById('roundTimer').textContent = `–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥: ${roundTimer}—Å`;
                
                if (roundTimer <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    document.getElementById('roundTimer').textContent = '–ò–¥–µ—Ç –ø–æ–ª–µ—Ç!';
                    document.getElementById('placeBetBtn').disabled = false;
                }
            }, 1000);
        }

        async function loadActiveBets() {
            try {
                const response = await fetch('/api/rocket/active-bets');
                if (response.ok) {
                    const bets = await response.json();
                    updateBetsList(bets);
                    updatePlayersCount(bets.length);
                }
            } catch (error) {
                console.error('Error loading active bets:', error);
            }
        }

        function updateBetsList(bets) {
            const container = document.getElementById('betsContainer');
            const countElement = document.getElementById('activeBetsCount');
            
            countElement.textContent = bets.length;
            
            if (bets.length === 0) {
                container.innerHTML = '<div class="no-bets">–°—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }
            
            container.innerHTML = '';
            bets.forEach(bet => {
                const betElement = document.createElement('div');
                betElement.className = 'bet-item';
                betElement.innerHTML = `
                    <span>${bet.username}</span>
                    <span>${bet.amount} TON</span>
                `;
                container.appendChild(betElement);
            });
        }

        function addBetToList(username, amount) {
            const container = document.getElementById('betsContainer');
            const countElement = document.getElementById('activeBetsCount');
            
            // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç"
            if (container.querySelector('.no-bets')) {
                container.innerHTML = '';
            }
            
            const betElement = document.createElement('div');
            betElement.className = 'bet-item';
            betElement.innerHTML = `
                <span>${username}</span>
                <span>${amount} TON</span>
            `;
            container.appendChild(betElement);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            const currentCount = parseInt(countElement.textContent);
            countElement.textContent = currentCount + 1;
        }

        function updatePlayersCount(count) {
            activePlayers = count;
            document.getElementById('playersCount').textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${count}`;
        }

        function updateFakePlayersCount() {
            // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 50+ –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω
            document.getElementById('fakePlayers').textContent = '–í—Å–µ–≥–æ –æ–Ω–ª–∞–π–Ω: 50+';
        }

        async function updateBalance() {
            try {
                const tg = window.Telegram.WebApp;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const telegramId = tg.initDataUnsafe.user.id;
                    
                    const response = await fetch(`/api/user/${telegramId}`);
                    if (response.ok) {
                        userData = await response.json();
                        document.getElementById('balance').textContent = userData.balance.toFixed(2);
                    }
                }
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }
    </script>
</body>
</html>